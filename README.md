# 콕스웨이브 과제: RAG 기반 스마트스토어 FAQ 챗봇

## 개요

**스마트스토어 FAQ 챗봇**은 스마트스토어 플랫폼에 대한 사용자 질문에 대해 정확하고 효율적인 답변을 제공합니다.

- 응답 메뉴얼: RAG (Retrieval-Augmented Generation), BM25, LLM 등을 활용하여 높은 품질의 응답을 보장

## 요구 사항

[요구 사항 확인하기](./docs/README.md)

---

## 아키텍처

### 1. API 서버 영역

- **기능**: UI와 도메인 계층 간의 통신을 관리하며 RESTful API를 제공합니다.
- **구성 요소**:
  - **Routes**: RESTful API 엔드포인트 정의. 사용자가 질문을 입력하고 답변을 확인하는 인터페이스 제공.
  - **Controllers**: 라우트에서 호출되는 함수. 내부에는 LLM 인스턴스를 호출.

### 2. 도메인 (LLMChain) 영역 (아키텍쳐는 LLM 오케스트레이션 프레임워크에서 착안)

- **기능**: 데이터 전처리, 검색, 그리고 응답 생성까지의 핵심 로직을 담당.
- **구성 요소**:
  1. **Preprocess 모듈**:
     - load: 데이터를 로드하고 효율적으로 저장 및 검색할 수 있도록 분리.
     - split: 중복 제거 및 불필요한 텍스트 삭제. row 데이터를 **해시테이블**로 구성.
  2. **Vector Store 및 Retrieval 모듈**:
     - store: 전처리된 데이터를 저장.
     - query 메서드: RAG를 기반으로 질문에 적합한 데이터를 검색.
  3. **LLMGenerator 모듈**:
     - generateQueryPrompt 메서드: 쿼리 수정. 쿼리 문장 중, 키워드를 재생성. 스마트스토어와 관련 없는 질문에는 아래와 같은 기본 응답 제공:
      ```
      저는 스마트 스토어 FAQ를 위한 챗봇입니다. 스마트 스토어에 대한 질문을 부탁드립니다.
      ```
     - getResponse 메서드: 해시 테이블로 맵핑된 FAQ 답변 데이터(`processed_data.json`) 를 기반으로 고품질 답변 생성.
     - 대화 기록을 저장하여 맥락 기반 답변 제공.
     - 질문-답변 맥락에서 사용자가 궁금해할만한 추가 질문을 제안.
   4. **LLM Chain 모듈**:
	    - 3가지 모듈을 조합하는 인터페이스 클래스. Controllers에서 인스턴스를 생성.


---

## 개선 방안

### 0. **접근 아이디어**

- **AI 프로덕트의 3가지 성능 방법**:
  - 프롬프트 엔지니어링, RAG, Fine-tuning 중, RAG를 이용하는 것이 이번 과제.
  - 그 중, 빠르게 구축할 수 있는 **프롬프트 엔지니어링** 역시 적극적으로 이용하기로 함. 즉, (프롬프트 + RAG) 앙상블
- **모듈 계층에 따라, 성능 개선 연구**
	- RAG의 기본 아키텍쳐는 LLM 오케스트레이션 프레임워크에서 착안: 전처리, 저장 및 검색, 답변 생성
		- 전처리: AI 성능에서 가장 중요한 것은 데이터. 따라서, 데이터 전처리가 매우 중요.
		- 저장 및 검색: 저장 비용은 비싸므로, 핵심인 **질문** 데이터만 저장하고, 답변은 질문과 해시테이블로 연동. 비용 절감
		- 답변 생성: **프롬프트 엔지니어링** 적극 이용.


### 1. **전처리 개선**

- 중복 제거 및 불필요한 텍스트 (답변 평정 관련) 삭제.
- **데이터 해시 테이블화**: 질문, 답변 형태의 해시테이블로 구성. 사용자 쿼리에 대한 유사도는 **질문** 데이터만 집중해, 비용 절감 유도.
- **관련 도움말/키워드 메타 데이터 분리**: 미리 제공되는 **관련 도움말/키워드**를 따로 메타 데이터로 분리. 추후, 문장 생성 비용 절감.
- 답변 데이터를 유사도 검색 및 답변 생성에 유용하게 이용할 수 있도록 chunks 단위로 분리.

### 2. **RAG 성능 개선 연구 및 적용*

- **쿼리 재생성**:
  - 유저의 쿼리에서 키워드를 추출하는 llm 프롬프트 작성.
  - 키워드 추출을 통해, 쿼리 정확도 향상. (BM25 엘라스틱 서치에서 아이디어 얻음.)
  - 부적절한 질문을 미리 점검해, 답변 조기 종료. Retreival 비용 절감.
- **Embedding 최소화**:
  - 유저 쿼리는 질문 형태이므로, 해당 질문이 기존 데이터의 **질문 데이터**와 얼마나 유사한가를 파악하면 됨. 
  - **질문 데이터**만 벡터 스토어에 저장. Retreival 비용 절감.
- **맥락 이해**:
  - llm Generator 에 대화 히스토리 저장 적용. 따로 벡터 스토어에 저장하지 않음. (비용 최소화)
  - 다양한 프롬프트 템플릿 실험을 통해 문맥 이해도 향상.
  
### 3. **프롬프트 연구**

- **프롬프트 엔지니어링 강수진 박사님 자료 참고**: (출처: https://www.youtube.com/watch?v=IstX_cGtGjw)
 - 프롬프트 구조화.
 - 대시, 슬래시 등을 이용해, 자료 구별.
 - 출력 예시를 넣을 것.
 - play ground를 통해, 실험. 직접 체감하는 것도 중요.

### 4. **추가 아키텍쳐 연구**
-  **Anthropic사에서 RAG성능을 향상시키기 위한 기법**: (출처: https://www.anthropic.com/news/contextual-retrieval)
	- BM25 + Embedding 모델의 앙상블 조합으로, 검색 정확도 향상
		- 실험 결과, BM25는 정확한 답변일 경우, 큰 값, Embedding 모델은 작은 값을 제시. 따라서 앙상블 시, 정규화를 도입해야 함.
		- 또한 JS에서, BM25 알고리즘은 **한국어 지원이 어려움**. 파이썬 코드를 혼합해야 함. (멀티 스레드 child_process 사용)
	- reRank 기법
		- 이 역시, JS에서 **한국어 지원이 어려움**.
		- 또한, 추가 비용 및, 속도 저하가 발생.
- **post, pre Retreival 및 Advenced RAG**:
	- 쿼리를 벡터 스토어로 넣기 이전, 쿼리를 재생성하여 검색 정확도 향상 (BM 25에서 키워드 추가에 대한 아이디어를 얻음.)
	- post Retreival을 다양한 아키텍쳐 구상. 이 중, 빠르게 실험할 수 있는 것부터 실험에 넣음.
		- pre Retreival 및 RAG로 추출한 상위 10개 데이터 및 답변 데이터를 프롬프트에 넣어, 추가 점검 및 생성. (적용 O)
		- 미리 파인튜닝한 모델 적용. (MLOps까지 적용해야 하므로, 시간 오래 걸림. 적용 X)	
- **이러한 아키텍쳐 및 기법을 혼합해서, 가장 정확하게 답변을 생성하는 아키텍쳐를 선별할 수 있음**
